"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const s=require("fs"),q=require("glob/sync.js"),l=require("path"),b=e=>e&&typeof e=="object"&&"default"in e?e:{default:e};function I(e){if(e&&e.__esModule)return e;const t=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(e){for(const r in e)if(r!=="default"){const n=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,n.get?n:{enumerable:!0,get:()=>e[r]})}}return t.default=e,Object.freeze(t)}const M=b(s),k=b(q),m=b(l);function T(){return()=>{}}function A(e){return e}function P(){}function E(e){if(Array.isArray(e))return function(n){return n.map(i=>E(i))}(e);let t=(e=function(n={}){return function(i=T,o=A,a=P,c={}){n.src=i,n.proc=o,n.sink=a,n.meta=c}(n.src,n.proc,n.sink,n.meta),n}(e)).src,r=e.proc(t,e.meta);return e.sink(r,e.meta)}function y(e){return typeof e=="object"?l.format(e):e}function O(e){let t="";return e.p&&(t+=e.p),e.w&&(t+=e.w),e.a&&(t+=e.a),t}function _(e,t,r){let n=s.readFileSync(e);r&&(n+=r.toString());const i=s.openSync(e,"w+"),o=Buffer.from(t);s.writeSync(i,o,0,o.length,0),s.writeSync(i,n,0,n.length,o.length),s.close(i,a=>{if(a)throw a})}function v(e,t,r){let{p:n,w:i,a:o}=t;if(i)return t=O(t),void s.writeFileSync(e,t.toString(),r==null?void 0:r.options);n===void 0&&o===void 0||(n===void 0&&o?s.appendFileSync(e,o.toString(),r==null?void 0:r.options):_(e,n,o))}const W="./src/task/*.js",x={glob:"./src/**/*.js",delay:100};let p;const u={},F=e=>u[e.id]=e,S=e=>u[e]!==void 0;function g(e,t,r){t={id:e,...t};const n=Date.now();u[e].main(t,r);const i=Date.now();return{start:n,stop:i,dur:i-n}}function C(e){const t={id:m.default.basename(p||"",m.default.extname(p||"")),url:p,...e};F(t)}function w(){process.listenerCount("task")==0&&process.on("task",C)}let d;function j(e=x.glob){return d=k.default(e),e}exports.bypass=A,exports.cat=function(e,t){return e=y(e||(t==null?void 0:t.path)),s.readFileSync(e,(t==null?void 0:t.options)||"utf-8")},exports.chain=function(){let e={};return{src(t){return e.pipe=t,this},done:()=>e.sink,meta(t){return e.meta=t,this},useProc(t){return e.curProc=t,this},proc(t,r){return r&&this.meta(r),typeof t=="object"&&(t=meta(e.curProc,t)),e.pipe=t(e.pipe,e.meta||{}),this},useSink(t){return e.curSink=t,this},sink(t,r){return r&&this.meta(r),typeof t=="object"&&(t=meta(e.curSink,t)),e.sink=t(e.pipe,e.meta||{}),this},series(...t){return t.forEach(r=>this.proc(r)),this},parallel(...t){return t.forEach(r=>this.sink(r)),this}}},exports.clean=function e(t,r){return Array.isArray(t)?void t.forEach(n=>e(n,r)):(t=y(t),k.default(t).forEach(n=>{s.rmSync(n,{recursive:!0,force:!0,...r==null?void 0:r.options})}),t)},exports.dummySink=P,exports.dummySrc=T,exports.formatWriteObj=O,exports.handleWrite=v,exports.hasTask=S,exports.hasWatchables=()=>d.length>0,exports.initApi=()=>process.env.VESIC_API=!0,exports.initWatch=j,exports.isTaskRunnable=function(e){return!(!S(e)||!u[e].main)&&typeof u[e].main=="function"},exports.listenTask=w,exports.loadTasks=async function(e=W){w();const t=await k.default(e,{});for(let r of t)p=r,await Promise.resolve().then(()=>I(require(m.default.resolve(r))))},exports.meta=function(e,t){return r=>e(r,t)},exports.mkfile=function(e,t){let r=y(t==null?void 0:t.path);const n=l.dirname(r);let i,o=e!==void 0;if(typeof e=="object"){const{a,w:c,p:f}=e;if(!a&&!c&&!f)return o=!1,e;i=()=>v(r,{a,w:c,p:f},t)}return!s.existsSync(r)&&o&&s.mkdirSync(n,{recursive:!0}),i?i():v(r,{w:e},t),e},exports.mv=function e(t,r){if(Array.isArray(t))return void t.forEach(o=>e(o,r));let n=l.parse(t),i=r.path;if(typeof i=="object"){const{root:o,dir:a,base:c,ext:f,name:h}=r.path;f===void 0&&h===void 0||(n.base=void 0),o!==void 0&&(n.root=o),a!==void 0&&(n.dir=a),c!==void 0&&(n.base=c),f!==void 0&&(n.ext=f),h!==void 0&&(n.name=h),i=l.format(n)}return s.renameSync(t,i),i},exports.parallel=function(...e){return(t,r)=>e.map(n=>n(t,r))},exports.prependFile=_,exports.print=function(e){console.log(e)},exports.registerTask=F,exports.runTask=g,exports.series=function(...e){return(t,r)=>e.reduce((n,i)=>i(n,r),t)},exports.task=function(e){process.env.VESIC_API==="true"?process.emit("task",e):e.main()},exports.tasks=u,exports.unregisterTask=e=>u[e]=void 0,exports.vesic=E,exports.watchTask=function(e,t){t={...x,...t},!d&&j(t.glob);const r={id:e,...t};d.forEach((n,i)=>{let o=!1;M.default.watch(m.default.resolve(n),(a,c)=>{o||(o=!0,g(e,r,{watch:{event:a,filename:c,file:n}}),setTimeout(()=>{o=!1},t.delay))})})};
