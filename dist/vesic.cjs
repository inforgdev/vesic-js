"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const s=require("fs"),q=require("glob/sync.js"),y=require("path"),k=e=>e&&typeof e=="object"&&"default"in e?e:{default:e};function I(e){if(e&&e.__esModule)return e;const t=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(e){for(const n in e)if(n!=="default"){const r=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,r.get?r:{enumerable:!0,get:()=>e[n]})}}return t.default=e,Object.freeze(t)}const M=k(s),h=k(q),p=k(y);function j(){return()=>{}}function T(e){return e}function P(){}function A(e){if(Array.isArray(e))return function(r){return r.map(i=>A(i))}(e);let t=(e=function(r={}){return function(i=j,o=T,c=P,u={}){r.src=i,r.proc=o,r.sink=c,r.meta=u}(r.src,r.proc,r.sink,r.meta),r}(e)).src,n=e.proc(t,e.meta);return e.sink(n,e.meta)}function d(e){return typeof e=="object"?y.format(e):e}function E(e){let t="";return e.p&&(t+=e.p),e.w&&(t+=e.w),e.a&&(t+=e.a),t}function O(e,t,n){let r=s.readFileSync(e);n&&(r+=n.toString());const i=s.openSync(e,"w+"),o=Buffer.from(t);s.writeSync(i,o,0,o.length,0),s.writeSync(i,r,0,r.length,o.length),s.close(i,c=>{if(c)throw c})}function m(e,t,n){let{p:r,w:i,a:o}=t;if(i)return t=E(t),void s.writeFileSync(e,t.toString(),n==null?void 0:n.options);r===void 0&&o===void 0||(r===void 0&&o?s.appendFileSync(e,o.toString(),n==null?void 0:n.options):O(e,r,o))}const W="./src/task/*.js",_={glob:"./src/**/*.js",delay:100};let f;const a={},F=e=>a[e.id]=e,b=e=>a[e]!==void 0;function g(e,t,n){t={id:e,...t};const r=Date.now();a[e].main(t,n);const i=Date.now();return{start:r,stop:i,dur:i-r}}function x(e){const t={id:p.default.basename(f||"",p.default.extname(f||"")),url:f,...e};F(t)}function v(){process.listenerCount("task")==0&&process.on("task",x)}let l;function w(e=_.glob){return l=h.default(e),e}exports.bypass=T,exports.cat=function(e,t){return e=d(e||(t==null?void 0:t.path)),s.readFileSync(e,(t==null?void 0:t.options)||"utf-8")},exports.chain=function(){let e={};return{src(t){return e.pipe=t,this},done:()=>e.sink,meta(t){return e.meta=t,this},useProc(t){return e.curProc=t,this},proc(t,n){return n&&this.meta(n),typeof t=="object"&&(t=meta(e.curProc,t)),e.pipe=t(e.pipe,e.meta||{}),this},useSink(t){return e.curSink=t,this},sink(t,n){return n&&this.meta(n),typeof t=="object"&&(t=meta(e.curSink,t)),e.sink=t(e.pipe,e.meta||{}),this},series(...t){return t.forEach(n=>this.proc(n)),this},parallel(...t){return t.forEach(n=>this.sink(n)),this}}},exports.clean=function e(t,n){return Array.isArray(t)?void t.forEach(r=>e(r)):(t=d(t),h.default(t).forEach(r=>{s.rmSync(r,{recursive:!0,force:!0,...n==null?void 0:n.options})}),t)},exports.dummySink=P,exports.dummySrc=j,exports.formatWriteObj=E,exports.handleWrite=m,exports.hasTask=b,exports.hasWatchables=()=>l.length>0,exports.initApi=()=>process.env.VESIC_API=!0,exports.initWatch=w,exports.isTaskRunnable=function(e){return!(!b(e)||!a[e].main)&&typeof a[e].main=="function"},exports.listenTask=v,exports.loadTasks=async function(e=W){v();const t=await h.default(e,{});for(let n of t)f=n,await Promise.resolve().then(()=>I(require(p.default.resolve(n))))},exports.meta=function(e,t){return n=>e(n,t)},exports.mkfile=function(e,t){let n=d(t==null?void 0:t.path);const r=y.dirname(n);let i,o=e!==void 0;if(typeof e=="object"){const{a:c,w:u,p:S}=e;if(!c&&!u&&!S)return o=!1,e;i=()=>m(n,{a:c,w:u,p:S},t)}return!s.existsSync(n)&&o&&s.mkdirSync(r,{recursive:!0}),i?i():m(n,{w:e},t),e},exports.parallel=function(...e){return(t,n)=>e.map(r=>r(t,n))},exports.prependFile=O,exports.print=function(e){console.log(e)},exports.registerTask=F,exports.runTask=g,exports.series=function(...e){return(t,n)=>e.reduce((r,i)=>i(r,n),t)},exports.task=function(e){process.env.VESIC_API==="true"?process.emit("task",e):e.main()},exports.tasks=a,exports.unregisterTask=e=>a[e]=void 0,exports.vesic=A,exports.watchTask=function(e,t){t={..._,...t},!l&&w(t.glob);const n={id:e,...t};l.forEach((r,i)=>{let o=!1;M.default.watch(p.default.resolve(r),(c,u)=>{o||(o=!0,g(e,n,{watch:{event:c,filename:u,file:r}}),setTimeout(()=>{o=!1},t.delay))})})};
