"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const a=require("fs"),d=require("path"),W=require("glob/sync.js"),b=e=>e&&typeof e=="object"&&"default"in e?e:{default:e};function C(e){if(e&&e.__esModule)return e;const t=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(e){for(const n in e)if(n!=="default"){const r=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,r.get?r:{enumerable:!0,get:()=>e[n]})}}return t.default=e,Object.freeze(t)}const D=b(a),h=b(d),k=b(W);function E(){return()=>{}}function T(e){return e}function P(){}function x(e){if(Array.isArray(e))return function(r){return r.map(i=>x(i))}(e);let t=(e=function(r={}){return function(i=E,o=T,c=P,s={}){r.src=i,r.proc=o,r.sink=c,r.meta=s}(r.src,r.proc,r.sink,r.meta),r}(e)).src,n=e.proc(t,e.meta);return e.sink(n,e.meta)}function y(e){return typeof e=="object"?d.format(e):e}function O(e){let t="";return e.p&&(t+=e.p),e.w&&(t+=e.w),e.a&&(t+=e.a),t}function F(e,t,n){let r=a.readFileSync(e);n&&(r+=n.toString());const i=a.openSync(e,"w+"),o=Buffer.from(t);a.writeSync(i,o,0,o.length,0),a.writeSync(i,r,0,r.length,o.length),a.close(i,c=>{if(c)throw c})}function v(e,t,n){let{p:r,w:i,a:o}=t;if(i)return t=O(t),void a.writeFileSync(e,t.toString(),n==null?void 0:n.options);r===void 0&&o===void 0||(r===void 0&&o?a.appendFileSync(e,o.toString(),n==null?void 0:n.options):F(e,r,o))}function S(e){const t=d.dirname(e);a.existsSync(t)||a.mkdirSync(t,{recursive:!0})}const N="./src/task/*.js",I={glob:"./src/**/*.js",delay:100};let p;const l={},_=e=>l[e.id]=e,g=e=>l[e]!==void 0;function w(e,t,n){t={id:e,...t};const r=Date.now();l[e].main(t,n);const i=Date.now();return{start:r,stop:i,dur:i-r}}function V(e){const t={id:h.default.basename(p||"",h.default.extname(p||"")),url:p,...e};_(t)}function j(){process.listenerCount("task")==0&&process.on("task",V)}let m;function A(e=I.glob){return m=k.default(e),e}exports.bypass=T,exports.cat=function(e,t){return e=y(e||(t==null?void 0:t.path)),a.readFileSync(e,(t==null?void 0:t.options)||"utf-8")},exports.chain=function(){let e={};return{src(t){return e.pipe=t,this},done:()=>e.sink,meta(t){return e.meta=t,this},useProc(t){return e.curProc=t,this},proc(t,n){return n&&this.meta(n),typeof t=="object"&&(t=meta(e.curProc,t)),e.pipe=t(e.pipe,e.meta||{}),this},useSink(t){return e.curSink=t,this},sink(t,n){return n&&this.meta(n),typeof t=="object"&&(t=meta(e.curSink,t)),e.sink=t(e.pipe,e.meta||{}),this},series(...t){return t.forEach(n=>this.proc(n)),this},parallel(...t){return t.forEach(n=>this.sink(n)),this}}},exports.clean=function e(t,n){return Array.isArray(t)?void t.forEach(r=>e(r,n)):(t=y(t),k.default(t).forEach(r=>{a.rmSync(r,{recursive:!0,force:!0,...n==null?void 0:n.options})}),t)},exports.concat=function(e,t){const n=t.header||`
`,r=t.footer||"";let i=[];if(Array.isArray(e)?i=e:i.push(e),e===void 0||i.length===0)return;let o="";function c(s,u,f){return typeof s=="function"?s(u,f,i.length):s}return i.forEach((s,u)=>{const f=a.readFileSync(s),q=c(n,s,u),M=c(r,s,u);o+=q+f+M}),o},exports.dummySink=P,exports.dummySrc=E,exports.formatWriteObj=O,exports.handleWrite=v,exports.hasTask=g,exports.hasWatchables=()=>m.length>0,exports.initApi=()=>process.env.VESIC_API=!0,exports.initWatch=A,exports.isTaskRunnable=function(e){return!(!g(e)||!l[e].main)&&typeof l[e].main=="function"},exports.listenTask=j,exports.loadTasks=async function(e=N){j();const t=await k.default(e,{});for(let n of t)p=n,await Promise.resolve().then(()=>C(require(h.default.resolve(n))))},exports.meta=function(e,t){return n=>e(n,t)},exports.mkdirIfNotExists=S,exports.mkfile=function(e,t){let n,r=y(t==null?void 0:t.path),i=e!==void 0;if(typeof e=="object"){const{a:o,w:c,p:s}=e;if(!o&&!c&&!s)return i=!1,e;n=()=>v(r,{a:o,w:c,p:s},t)}return i&&mkdirIfNotExists(r),n?n():v(r,{w:e},t),e},exports.mv=function e(t,n){if(Array.isArray(t))return void t.forEach(o=>e(o,n));let r=d.parse(t),i=n.path;if(typeof i=="object"){const{root:o,dir:c,base:s,ext:u,name:f}=n.path;u===void 0&&f===void 0||(r.base=void 0),o!==void 0&&(r.root=o),c!==void 0&&(r.dir=c),s!==void 0&&(r.base=s),u!==void 0&&(r.ext=u),f!==void 0&&(r.name=f),i=d.format(r)}return S(i),a.renameSync(t,i),i},exports.parallel=function(...e){return(t,n)=>e.map(r=>r(t,n))},exports.prependFile=F,exports.print=function(e){console.log(e)},exports.registerTask=_,exports.runTask=w,exports.series=function(...e){return(t,n)=>e.reduce((r,i)=>i(r,n),t)},exports.task=function(e){process.env.VESIC_API==="true"?process.emit("task",e):e.main()},exports.tasks=l,exports.unregisterTask=e=>l[e]=void 0,exports.vesic=x,exports.watchTask=function(e,t){t={...I,...t},!m&&A(t.glob);const n={id:e,...t};m.forEach((r,i)=>{let o=!1;D.default.watch(h.default.resolve(r),(c,s)=>{o||(o=!0,w(e,n,{watch:{event:c,filename:s,file:r}}),setTimeout(()=>{o=!1},t.delay))})})};
